//Window Start
var favWin = Ti.UI.createWindow({
	title : 'Stored',
	backgroundColor : 'red'
});
exports.favWin = favWin;
//Window End

var dataB = Ti.Database.open("GeoDB");
dataB.execute('CREATE TABLE IF NOT EXISTS location (id INTEGER PRIMARY KEY, name TEXT, population TEXT, longitude INTEGER, latitude INTEGER, distance TEXT, county TEXT, state TEXT)');

var buildRow = function() {
	var data = [];
	var test = dataB.execute("SELECT * FROM location");

	while (test.isValidRow()) {
		var name = test.fieldByName('name');
		var state = test.fieldByName('state');
		var county = test.fieldByName('county');
		var latitude = test.fieldByName('latitude');
		var longitude = test.fieldByName('longitude');
		var distance = test.fieldByName('distance');
		var population = test.fieldByName('population');
		var id = test.fieldByName('id');

		data.push({
			title : name,
			state : state,
			county : county,
			latitude : latitude,
			longitude : longitude,
			distance : distance,
			population : population,
			id : id
		});
		test.next();
	};
	return data;
};

////////////////////////////////////// Prompt START //////////////////////////////////////
var promptHolder = Ti.UI.createView({
	width : Ti.UI.FILL,
	height : Ti.UI.FILL,
	backgroundColor : "black",
	opacity : 0.8
});
var prompt = Ti.UI.createView({
	backgroundColor : "#FFF",
	width : '40%',
	height : '20%',
	borderRadius : '15%'
});


	//Delete button
	var button1 = Ti.UI.createButton({
		title : "Delete",
		left : '10%',
		bottom : '5%',
		font : {
			fontSize : 22
		}
	});

	//Cancel (closes the prompt)
	var button3 = Ti.UI.createButton({
		title : "Cancel",
		right : '10%',
		bottom : '5%',
		font : {
			fontSize : 22
		}
	});

	var label = Ti.UI.createLabel({
		text : "Are you sure you want to delete this item?",
		font : {
			fontSize : 26
		},
		textAlign : 'center',
		top : '7%',
		right : '3%',
		left : '3%'
	}); 


prompt.add(button1, button3, label);
prompt.visible = false;
promptHolder.visible = false;
////////////////////////////////////// Prompt END //////////////////////////////////////

var table = Ti.UI.createTableView({
	font : {
		fontStyle : 'Helvetica',
		fontSize : 18
	}
});

table.addEventListener("click", function(e) {

		//console.log(e.source.id);
		//console.log(e.rowData.id);
		var id = e.source.id;
		//Displays the prompt
		prompt.visible = true;
		promptHolder.visible = true;

		//SQL Delete
		button1.addEventListener("click", function(e) {
			dataB.execute("DELETE FROM location WHERE id=?", id);
			prompt.visible = false;
			promptHolder.visible = false;
			table.setData(buildRow());
		});

		button3.addEventListener("click", function() {
			prompt.visible = false;
			promptHolder.visible = false;
		});

	});

});

//Main Code
table.setData(buildRow());
favWin.add(table, promptHolder, prompt);
